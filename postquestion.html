<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Upload Challenges</title>
    <!-- Note: Serve over http:// or https:// to avoid CORS and origin 'null' issues (e.g., python -m http.server) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #4338ca;
            --accent-color: #38bdf8;
            --light-color: #f8fafc;
            --dark-color: #1e293b;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --border-radius: 10px;
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e2e8f0 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link {
            color: white !important;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: var(--transition);
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-color) !important;
            transform: translateY(-2px);
        }

        .card {
            border: none;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: 8px;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .form-control {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.2);
        }

        .table {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #64748b;
            padding: 1rem;
        }

        .table td {
            vertical-align: middle;
            padding: 1rem;
        }

        .footer {
            background: var(--dark-color);
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }

        .alert {
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            border-width: 0.15em;
        }

        .progress {
            height: 1.5rem;
            border-radius: 8px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .card-header h5 {
                font-size: 1rem;
            }

            .btn-primary {
                padding: 0.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-seedling"></i> Script Sprouts
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="home.html"><i class="fas fa-home me-1"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="challenge.html"><i class="fas fa-trophy me-1"></i> Challenge</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="postch.html"><i class="fas fa-cog me-1"></i> Manage Challenges</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="postquestion.html"><i class="fas fa-upload me-1"></i> Upload Challenges</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4 fade-in">
                    <h2 class="mb-0"><i class="fas fa-upload me-2"></i> Upload Challenges</h2>
                    <div id="currentTime" class="text-muted fw-medium"></div>
                </div>

                <!-- Upload Form -->
                <div class="card fade-in">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i> Upload Challenge Documents</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadChallengeForm">
                            <div class="mb-4">
                                <label for="documentFiles" class="form-label">Select Documents and Media</label>
                                <input type="file" class="form-control" id="documentFiles" accept=".docx,.wps,image/jpeg,image/png,image/gif,video/mp4,video/webm" multiple required>
                                <div class="form-text">
                                    Upload up to 20 Word (.docx) or WPS (.wps) files, along with referenced images (JPG, PNG, GIF) or videos (MP4, WebM). Max 10MB per file.
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="publishImmediately" checked>
                                    <label class="form-check-label" for="publishImmediately">Publish immediately</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showResultsImmediately">
                                    <label class="form-check-label" for="showResultsImmediately">Show results to participants immediately</label>
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-upload me-2"></i> Process and Upload
                                </button>
                            </div>
                        </form>
                        <div class="progress mt-3 d-none" id="uploadProgress">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%;" id="progressBar">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="card fade-in mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i> Upload Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th>Challenge Title</th>
                                        <th>Questions</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">© 2025 Script Sprouts. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.8.0/mammoth.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcnCKmcXcgUBHOGGEj8dizh2ybY7iQ7JI",
            authDomain: "script-sprouts.firebaseapp.com",
            databaseURL: "https://script-sprouts-default-rtdb.firebaseio.com",
            projectId: "script-sprouts",
            storageBucket: "script-sprouts.firebasestorage.app",
            messagingSenderId: "223432338173",
            appId: "1:223432338173:web:549ca36657ea0b38b12c94",
            measurementId: "G-ZMCS394K9H"
        };

        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        function updateCurrentTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentTime').textContent = now.toLocaleDateString('en-US', options);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User signed in:", user.uid);
                updateCurrentTime();
                setInterval(updateCurrentTime, 60000);
            } else {
                window.location.href = "index.html";
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Error signing out:", error);
                showAlert('danger', 'Failed to sign out: ' + error.message);
            });
        });

        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container.my-5').prepend(alert);
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        }

        document.getElementById('uploadChallengeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            const files = document.getElementById('documentFiles').files;
            const docFiles = Array.from(files).filter(file =>
                file.name.match(/\.(docx|wps)$/i)
            );
            const mediaFiles = Array.from(files).filter(file =>
                file.name.match(/\.(jpg|png|gif|mp4|webm)$/i)
            );

            if (docFiles.length === 0) {
                showAlert('warning', 'Please select at least one .docx or .wps file');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
            }

            if (docFiles.length > 20) {
                showAlert('warning', 'Maximum 20 document files allowed');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                return;
            }

            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('uploadProgress');
            const resultsTableBody = document.getElementById('resultsTableBody');
            resultsTableBody.innerHTML = '';
            progressContainer.classList.remove('d-none');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';

            try {
                const totalSteps = docFiles.length * 2; // Parsing + Uploading
                let completedSteps = 0;

                const challenges = [];
                for (const file of docFiles) {
                    if (file.size > 10 * 1024 * 1024) {
                        resultsTableBody.innerHTML += `
                            <tr>
                                <td>${file.name}</td>
                                <td>-</td>
                                <td>-</td>
                                <td><span class="badge bg-danger">File too large (>10MB)</span></td>
                            </tr>
                        `;
                        continue;
                    }

                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    const text = result.value;

                    const challenge = parseChallengeText(text, file.name, mediaFiles);
                    if (challenge.error) {
                        resultsTableBody.innerHTML += `
                            <tr>
                                <td>${file.name}</td>
                                <td>-</td>
                                <td>-</td>
                                <td><span class="badge bg-danger">${challenge.error}</span></td>
                            </tr>
                        `;
                        continue;
                    }

                    challenges.push({ file, challenge });
                    completedSteps++;
                    const progress = Math.round((completedSteps / totalSteps) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                }

                for (const { file, challenge } of challenges) {
                    try {
                        if (challenge.mediaFiles) {
                            const mediaUrls = [];
                            for (const mediaFile of challenge.mediaFiles) {
                                if (mediaFile.size > 10 * 1024 * 1024) {
                                    throw new Error(`Media file ${mediaFile.name} exceeds 10MB`);
                                }
                                const fileRef = ref(storage, `challenges/${challenge.title}/${Date.now()}_${mediaFile.name}`);
                                await uploadBytes(fileRef, mediaFile);
                                const url = await getDownloadURL(fileRef);
                                mediaUrls.push(url);
                            }
                            if (challenge.questions.some(q => q.media?.type === 'multiple-images')) {
                                challenge.questions.forEach(q => {
                                    if (q.media?.type === 'multiple-images') {
                                        q.media.url = mediaUrls;
                                    }
                                });
                            } else {
                                challenge.questions.forEach(q => {
                                    if (q.media) {
                                        q.media.url = mediaUrls[0];
                                    }
                                });
                            }
                        }

                        await addDoc(collection(db, "challenges"), {
                            title: challenge.title,
                            description: challenge.description,
                            duration: challenge.duration,
                            questions: challenge.questions,
                            active: document.getElementById('publishImmediately').checked,
                            showResultsImmediately: document.getElementById('showResultsImmediately').checked,
                            createdAt: Date.now(),
                            participantCount: 0
                        });

                        resultsTableBody.innerHTML += `
                            <tr>
                                <td>${file.name}</td>
                                <td>${challenge.title}</td>
                                <td>${challenge.questions.length}</td>
                                <td><span class="badge bg-success">Uploaded</span></td>
                            </tr>
                        `;
                    } catch (error) {
                        console.error(`Error uploading ${file.name}:`, error);
                        resultsTableBody.innerHTML += `
                            <tr>
                                <td>${file.name}</td>
                                <td>${challenge.title || '-'}</td>
                                <td>${challenge.questions?.length || '-'}</td>
                                <td><span class="badge bg-danger">Error: ${error.message}</span></td>
                            </tr>
                        `;
                    }

                    completedSteps++;
                    const progress = Math.round((completedSteps / totalSteps) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                }

                showAlert('success', 'Challenge processing completed');
                document.getElementById('uploadChallengeForm').reset();
            } catch (error) {
                console.error("Error processing files:", error);
                showAlert('danger', 'Failed to process files: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                setTimeout(() => {
                    progressContainer.classList.add('d-none');
                }, 2000);
            }
        });

        function parseChallengeText(text, fileName, mediaFiles) {
            try {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 3) {
                    return { error: 'Invalid document format' };
                }

                const challenge = {
                    title: '',
                    description: '',
                    duration: 15 * 60, // Default 15 minutes
                    questions: [],
                    mediaFiles: []
                };

                let currentQuestion = null;
                let currentOptions = [];
                let expectingOption = false;
                let expectingCorrect = false;

                for (const line of lines) {
                    if (!challenge.title && line.match(/^Challenge:\s*(.+)/i)) {
                        challenge.title = line.match(/^Challenge:\s*(.+)/i)[1].trim();
                        continue;
                    }
                    if (!challenge.description && line.match(/^Description:\s*(.+)/i)) {
                        challenge.description = line.match(/^Description:\s*(.+)/i)[1].trim();
                        continue;
                    }
                    if (line.match(/^Duration:\s*(\d+)\s*minutes/i)) {
                        const minutes = parseInt(line.match(/^Duration:\s*(\d+)/i)[1]);
                        challenge.duration = minutes * 60;
                        continue;
                    }
                    if (line.match(/^\d+\.\s*(.+)/)) {
                        if (currentQuestion) {
                            if (currentOptions.length < 2) {
                                return { error: 'Question must have at least 2 options' };
                            }
                            currentQuestion.options = currentOptions;
                            challenge.questions.push(currentQuestion);
                        }
                        currentQuestion = {
                            text: line.match(/^\d+\.\s*(.+)/)[1].trim(),
                            options: [],
                            correctAnswer: null
                        };
                        currentOptions = [];
                        expectingOption = true;
                        expectingCorrect = false;
                        continue;
                    }
                    if (expectingOption && line.match(/^[a-d]\.\s*(.+)/)) {
                        currentOptions.push(line.match(/^[a-d]\.\s*(.+)/)[1].trim());
                        continue;
                    }
                    if (line.match(/^Correct:\s*([a-d])/i)) {
                        if (!currentQuestion) {
                            return { error: 'Correct answer specified without a question' };
                        }
                        const correctLetter = line.match(/^Correct:\s*([a-d])/i)[1].toLowerCase();
                        currentQuestion.correctAnswer = ['a', 'b', 'c', 'd'].indexOf(correctLetter) + 1;
                        expectingOption = false;
                        expectingCorrect = true;
                        continue;
                    }
                    if (line.match(/^Image:\s*(.+)/i)) {
                        if (!currentQuestion) {
                            return { error: 'Image specified without a question' };
                        }
                        const mediaName = line.match(/^Image:\s*(.+)/i)[1].trim();
                        const mediaFile = mediaFiles.find(file => file.name === mediaName);
                        if (!mediaFile) {
                            return { error: `Media file ${mediaName} not found` };
                        }
                        challenge.mediaFiles.push(mediaFile);
                        currentQuestion.media = { type: 'image' };
                        continue;
                    }
                    if (line.match(/^Video:\s*(.+)/i)) {
                        if (!currentQuestion) {
                            return { error: 'Video specified without a question' };
                        }
                        const mediaName = line.match(/^Video:\s*(.+)/i)[1].trim();
                        const mediaFile = mediaFiles.find(file => file.name === mediaName);
                        if (!mediaFile) {
                            return { error: `Media file ${mediaName} not found` };
                        }
                        challenge.mediaFiles.push(mediaFile);
                        currentQuestion.media = { type: 'video' };
                        continue;
                    }
                    if (line.match(/^Images:\s*(.+)/i)) {
                        if (!currentQuestion) {
                            return { error: 'Images specified without a question' };
                        }
                        const mediaNames = line.match(/^Images:\s*(.+)/i)[1].split(',').map(name => name.trim());
                        if (mediaNames.length < 2 || mediaNames.length > 5) {
                            return { error: 'Multiple images must be 2-5 files' };
                        }
                        const foundMediaFiles = mediaNames.map(name => mediaFiles.find(file => file.name === name));
                        if (foundMediaFiles.some(file => !file)) {
                            return { error: `One or more media files not found: ${mediaNames.join(', ')}` };
                        }
                        challenge.mediaFiles.push(...foundMediaFiles);
                        currentQuestion.media = { type: 'multiple-images' };
                        continue;
                    }
                }

                if (currentQuestion) {
                    if (currentOptions.length < 2) {
                        return { error: 'Question must have at least 2 options' };
                    }
                    if (!currentQuestion.correctAnswer) {
                        return { error: 'Correct answer not specified for question' };
                    }
                    currentQuestion.options = currentOptions;
                    challenge.questions.push(currentQuestion);
                }

                if (!challenge.title) {
                    return { error: 'Challenge title not found' };
                }
                if (!challenge.description) {
                    return { error: 'Challenge description not found' };
                }
                if (challenge.questions.length === 0) {
                    return { error: 'No valid questions found' };
                }

                return challenge;
            } catch (error) {
                console.error(`Error parsing ${fileName}:`, error);
                return { error: 'Failed to parse document' };
            }
        }
    </script>
</body>
</html>